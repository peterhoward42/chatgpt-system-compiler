o  SYSTEM OVERVIEW (SYSTEM PLANE, MUST)

The system is a cloud-hosted HTTP API that receives runtime telemetry events from
the DrawExact web application, persists them at low cost, and exposes a live
analysis endpoint that computes aggregate user behaviour metrics derived from the
stored events.

o  PLATFORM AND DEPLOYMENT MODEL (SYSTEM PLANE, MUST)

The system must be implemented as a single Google Cloud Function deployed as a
single deployment. Ingestion and analysis must be exposed on the same public HTTPS
endpoint. The API is public and callable from browsers.

The Google Cloud Functions framework must be used and the deployment must be
source-based. The entry point function must be named InjestEvent and must live in
the root package. The root package must not be named main. The repository must not
include a local runner such as cmd/main.go.

o  GO TOOLCHAIN AND MODULE FILES (SYSTEM PLANE, MUST)

The implementation must use Go version 1.25, declared in go.mod using standard Go
module syntax. A go.mod file must be generated including the module name and all
required dependencies. A go.sum file must not be generated or committed. Any
external requirement for go.sum does not alter this rule unless explicitly stated
in a future specification revision.

o  CONFIGURATION POLICY (SYSTEM PLANE, MUST)

The deployed function URL is
https://service-injest-event-65030510907.europe-west2.run.app

The system must not use environment variables for non-secret configuration. All
non-secret configuration values must be compile-time constants. Changing
configuration requires redeployment.

o  TELEMETRY EVENT MODEL (SYSTEM PLANE, MUST)

The EventPayload schema is defined as follows.

SchemaVersion is an integer and must equal 1.

EventULID is a string and must be a valid ULID. Validation must perform strict ULID
parsing rather than relying on string length.

ProxyUserID is a string and must be a UUID version 4. It serves as the anonymised
DrawExact user identifier.

TimeUTC is a string and must parse as an RFC3339 timestamp. All timestamp semantics
are UTC.

Visit is an integer representing the session count at emission time and must lie
between 1 and 100000 inclusive.

Event is a string naming the event type. Its length must be between 4 and 40
characters. Its value must be exactly one of the following strings: launched,
quit, sign-in-started, sign-in-success, recoverable-javascript-error,
fatal-javascript-error, loaded-example, created-new-drawing,
retreived-save-drawing.

Parameters is a string containing event-specific opaque data. Its maximum length
is 80 characters. No structural guarantees are made about its contents.

o  PAYLOAD VALIDATION POLICY (SYSTEM PLANE, MUST)

All ingested payloads must satisfy the telemetry event model constraints. Payload
validation is the primary abuse mitigation strategy and enforces reasonable and
plausible input. The system is not intended to be adversarially robust.

o  HTTP INTERFACE (SYSTEM PLANE, MUST)

Permissive CORS must be supported. The Access-Control-Allow-Origin response header
must be set to "*". OPTIONS preflight requests must be handled correctly.

A POST request to the root path ingests a telemetry event. The Content-Type must be
application/json. The body must contain a JSON representation of EventPayload. On
success, the response must be HTTP 204 with no body. Invalid payloads must result
in HTTP 400. Unsupported content types must result in HTTP 415. Storage failures
must result in HTTP 500.

A GET request to the root path performs a live aggregate analysis. The request
accepts no parameters. On success, the response must be HTTP 200 with a JSON body
matching the analysis schema. Failures must result in HTTP 500.

o  PERSISTENCE STRATEGY (SYSTEM PLANE, MUST)

Telemetry events must be persisted using Google Cloud Storage. The storage bucket
must be named drawexact-telemetry. Each event must be stored as a separate object.
Objects are append-only and must not be modified after creation.

Object contents must be gzip-compressed. When decompressed, each object must
contain exactly one NDJSON line encoding a single EventPayload, followed by a
newline character.

o  STORAGE OBJECT NAMING (SYSTEM PLANE, LOCKED)

Each telemetry event object must be stored with an object name of the form
events/y=YYYY/m=MM/d=DD/hour=HH/EventULID.ndjson.gz. The year, month, day, and hour
must be extracted from EventPayload.TimeUTC. EventULID must be taken directly from
EventPayload.EventULID. The events/ prefix is constant.

o  ANALYSIS INTERFACE AND SCHEMA (SYSTEM PLANE, MUST)

The system must expose exactly one analysis operation via HTTP GET at the root
path. Analysis must be computed live on each request. No parameters are accepted
and no caching is performed.

The response must be JSON containing an object HowManyPeopleHave with integer
fields Launched, LoadedAnExample, TriedToSignIn, SucceededSigningIn,
CreatedTheirOwnDrawing, and RetreivedTheirASavedDrawing. The response must also
contain integer fields TotalRecoverableErrors and TotalFatalErrors.

o  ANALYSIS SEMANTICS (SYSTEM PLANE, MUST)

A distinct person is defined as a distinct ProxyUserID. Analysis is performed over
the entire stored event history without time windowing.

For each behaviour metric, the value represents the count of distinct ProxyUserID
values for which at least one corresponding event exists. TotalRecoverableErrors
and TotalFatalErrors represent total event counts, not distinct users.

Malformed stored event objects encountered during analysis must be skipped.
Analysis must not fail solely due to malformed historical data.

o  ANALYSIS MEMORY CONSTRAINTS (SYSTEM PLANE, ASSUME)

It is assumed that the complete set of stored telemetry objects is small enough to
be read fully into memory during analysis.

o  SECURITY AND ABUSE MODEL (SYSTEM PLANE, MUST)

The API is public. The only mitigated threat model is deliberate malevolent or
mischievous misuse. Validation for reasonableness and plausibility is considered
sufficient. The system does not attempt to mitigate denial-of-service attacks
beyond relying on Google Cloud infrastructure.

o  OPERATIONAL CHARACTERISTICS (SYSTEM PLANE, ASSUME)

A typical user session is assumed to produce approximately twenty events, last
roughly two hours, and occur once per day. The initial user population is assumed
to be on the order of five thousand users. Occasional dropped events are
acceptable. Latency is not critical. Cost minimisation is the primary operational
driver.

o  LOGGING POLICY (SYSTEM PLANE, MUST)

All errors must be logged to STDOUT so they are visible in the Google Cloud
dashboard. No other logging is permitted.

o  CODE ORGANISATION AND SEPARATION OF CONCERNS (GENERATION PLANE, SHOULD)

Generated code should separate concerns to maximise readability and to make the
public entrypoint(s) easy to test end-to-end using faked external interfaces.
Separation should be reflected in package structure, file structure, and
abstractions where they simplify reasoning. Simple designs are preferred over
clever ones.

The architecture should make it possible (but not necessary) to unit-test internal
components when fixturing is genuinely simpler; however, correctness evidence for
externally visible behaviour must primarily come from tests that drive the system
through its public interface(s).

o  TESTABILITY AND STRUCTURAL CONTRACT (GENERATION PLANE, MUST)


All interactions with external systems must be isolated behind minimal capability
interfaces defined in production code. Interfaces must describe required
capabilities rather than concrete technologies. Deterministic core logic must
depend only on these interfaces.